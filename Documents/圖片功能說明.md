# 圖片功能說明

## 概述

本專案使用 **MongoDB + Cloudinary** 來管理營隊照片：
- **MongoDB**：儲存圖片的 metadata（標題、描述、分類、年份等）
- **Cloudinary**：儲存和優化圖片本身，提供 CDN 加速

## 環境變數設定

在專案根目錄創建 `.env` 檔案，並設定以下環境變數：

```env
# MongoDB Atlas 連接字串（必填）
MONGODB_URI=mongodb+srv://<username>:<password>@<cluster>.mongodb.net/<database>?retryWrites=true&w=majority

# Cloudinary 配置（必填）
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
```

## 設定步驟

### 1. MongoDB Atlas 設定

1. 前往 [MongoDB Atlas](https://www.mongodb.com/cloud/atlas) 建立資料庫
2. 取得連接字串
3. 設定 IP 白名單（允許所有 IP 或指定部署環境 IP）
4. 將連接字串填入 `.env` 的 `MONGODB_URI`

### 2. Cloudinary 設定

1. 前往 [Cloudinary](https://cloudinary.com/) 註冊帳號
2. 在 Dashboard 取得：
   - Cloud Name
   - API Key
   - API Secret
3. 將這些資訊填入 `.env` 檔案

## 工作流程

### 上傳圖片流程

1. **上傳圖片到 Cloudinary**
   - 透過 Cloudinary Dashboard 上傳
   - 或使用 API 上傳（見下方）

2. **取得 Cloudinary URL 和 Public ID**
   - 上傳成功後會得到 `secure_url`（圖片 URL）
   - 和 `public_id`（公開 ID，用於後續優化）

3. **儲存到 MongoDB**
   - 將圖片 URL、Public ID 和 metadata 儲存到 MongoDB
   - MongoDB 儲存結構見下方

## 資料庫結構

MongoDB 中的 `gallery` collection 結構：

```typescript
{
  _id: ObjectId,
  title: string,              // 圖片標題（必填）
  description?: string,        // 圖片描述
  imageUrl: string,            // Cloudinary URL（必填）
  cloudinaryPublicId?: string, // Cloudinary 公開 ID（建議儲存）
  category: '活動花絮' | '歷史常設展' | '宣傳組資訊' | '其他', // 分類（必填）
  year?: number,               // 年份
  date?: string,               // 日期
  order?: number,              // 排序順序
  createdAt: Date,
  updatedAt: Date
}
```

## 使用方式

### 方式 1：透過 Cloudinary Dashboard 上傳（推薦）

1. 登入 Cloudinary Dashboard
2. 前往 Media Library
3. 上傳圖片（建議上傳到 `pctbsc/gallery` 資料夾）
4. 複製圖片的 `Secure URL` 和 `Public ID`
5. 透過 API 或直接操作 MongoDB 儲存 metadata

### 方式 2：使用 API 上傳

#### 上傳圖片到 Cloudinary

```typescript
import { uploadImageToCloudinary } from '@/lib/cloudinary';

// 上傳圖片
const result = await uploadImageToCloudinary(imageFile, 'pctbsc/gallery');
// result.url 是 Cloudinary URL
// result.publicId 是 Cloudinary 公開 ID
```

#### 儲存到 MongoDB

```typescript
// 透過 API 儲存
POST /api/gallery
Content-Type: application/json

{
  "title": "活動照片",
  "description": "活動描述",
  "imageUrl": "https://res.cloudinary.com/.../image.jpg",
  "cloudinaryPublicId": "pctbsc/gallery/image",
  "category": "活動花絮",
  "year": 2025,
  "date": "2025-01-26",
  "order": 1
}
```

## API 使用

### 獲取圖片

```javascript
// 獲取所有圖片
GET /api/gallery

// 獲取特定分類的圖片
GET /api/gallery?category=活動花絮

// 獲取特定年份的圖片
GET /api/gallery?year=2025

// 限制數量
GET /api/gallery?limit=10
```

### 新增圖片

```javascript
POST /api/gallery
Content-Type: application/json

{
  "title": "活動照片",
  "description": "活動描述",
  "imageUrl": "https://res.cloudinary.com/.../image.jpg",
  "cloudinaryPublicId": "pctbsc/gallery/image",
  "category": "活動花絮",
  "year": 2025,
  "date": "2025-01-26",
  "order": 1
}
```

## 圖片優化

### 使用 Cloudinary Public ID 進行優化

如果儲存了 `cloudinaryPublicId`，可以使用優化功能：

```typescript
import { getOptimizedImageUrl } from '@/lib/cloudinary';

// 獲取優化後的圖片 URL（自動調整大小、格式、品質）
const optimizedUrl = getOptimizedImageUrl('pctbsc/gallery/image', 800, 600);
```

### Cloudinary 自動優化

即使直接使用 `imageUrl`，Cloudinary 也會自動：
- 根據瀏覽器選擇最佳格式（WebP、AVIF 等）
- 透過 CDN 加速載入
- 可以透過 URL 參數調整大小

## 頁面使用

### 活動花絮頁面

訪問 `/promotion` 頁面可以查看所有圖片，支援分類篩選：
- 活動花絮
- 歷史常設展
- 宣傳組資訊
- 全部

### 在組件中使用

```tsx
import ImageGallery from '@/app/components/ImageGallery';

// 顯示特定分類的圖片
<ImageGallery category="活動花絮" title="活動花絮" />

// 顯示特定年份的圖片
<ImageGallery category="活動花絮" year={2025} />

// 限制顯示數量
<ImageGallery category="活動花絮" limit={6} />
```

## MongoDB + Cloudinary 的優勢

### 為什麼使用兩者？

1. **MongoDB 的優勢**：
   - 複雜查詢和篩選（分類、年份、日期等）
   - 靈活的資料結構
   - 容易關聯其他資料（宣傳組資訊、採訪內容等）
   - 完整的 CRUD 操作

2. **Cloudinary 的優勢**：
   - 自動圖片優化（壓縮、格式轉換）
   - 全球 CDN 加速
   - 自動調整大小
   - 免費方案有 25GB 儲存空間
   - 圖片轉換和處理功能

3. **兩者結合**：
   - MongoDB 管理 metadata，Cloudinary 管理圖片
   - 各司其職，發揮各自優勢
   - 靈活且高效

## 注意事項

1. **MongoDB Atlas 設定**：
   - 確保 IP 白名單包含您的部署環境 IP
   - 確保資料庫使用者有讀寫權限

2. **Cloudinary 設定**：
   - 免費方案有使用限制，請注意用量
   - 建議設定上傳限制和格式限制
   - 定期清理不需要的圖片以節省空間

3. **資料同步**：
   - 建議同時儲存 `imageUrl` 和 `cloudinaryPublicId`
   - `imageUrl` 用於直接顯示
   - `cloudinaryPublicId` 用於後續優化和管理

4. **安全性**：
   - 不要將 `.env` 提交到版本控制
   - 生產環境使用環境變數管理服務（如 Vercel 的環境變數設定）

## 下一步

1. 設定 MongoDB Atlas 連接
2. 設定 Cloudinary 帳號和環境變數
3. 上傳圖片到 Cloudinary
4. 將圖片資訊儲存到 MongoDB
5. 訪問 `/promotion` 頁面查看效果
